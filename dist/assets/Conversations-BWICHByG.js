import{j as e}from"./vendor-motion-Dl8lXUsH.js";import{a as o,L as v,h as w,J as M,a0 as N,aN as C,aH as L,b1 as S,X as E}from"./vendor-icons-BBHJ0ezg.js";import{s as x}from"./index-76QHltB_.js";import"./vendor-react-Ojr5pEEK.js";import"./vendor-supabase-CIvuJI4W.js";import"./vendor-date-BvD7TL1z.js";const z=()=>{const[a,m]=o.useState([]),[u,p]=o.useState(!0),[r,c]=o.useState(null),i=async()=>{p(!0);try{const{data:n,error:l}=await x.from("orders").select(`
                    id,
                    order_number,
                    status,
                    messages_locked,
                    messages_lock_reason,
                    created_at,
                    buyer:profiles!orders_buyer_id_fkey(id, full_name, email, avatar_url),
                    seller:profiles!orders_seller_id_fkey(id, full_name, email, avatar_url),
                    listing:listings(title)
                `).in("status",["paid","delivered","completed","disputed"]).order("created_at",{ascending:!1});if(l)throw l;const _=(await Promise.all((n||[]).map(async s=>{const{count:g}=await x.from("messages").select("id",{count:"exact",head:!0}).eq("order_id",s.id),{data:b}=await x.from("messages").select("created_at").eq("order_id",s.id).order("created_at",{ascending:!1}).limit(1).single(),{count:y}=await x.from("disputes").select("id",{count:"exact",head:!0}).eq("order_id",s.id),t=Array.isArray(s.buyer)?s.buyer[0]:s.buyer,j=Array.isArray(s.seller)?s.seller[0]:s.seller,k=Array.isArray(s.listing)?s.listing[0]:s.listing;return{order_id:s.id,order_number:s.order_number,status:s.status,messages_locked:s.messages_locked||!1,messages_lock_reason:s.messages_lock_reason,buyer:t||{id:"",full_name:"Unknown",email:""},seller:j||{id:"",full_name:"Unknown",email:""},listing_title:(k==null?void 0:k.title)||"Unknown Item",message_count:g||0,last_message_at:b==null?void 0:b.created_at,has_dispute:(y||0)>0,created_at:s.created_at}}))).sort((s,g)=>{const b=s.last_message_at||s.created_at,y=g.last_message_at||g.created_at;return new Date(y).getTime()-new Date(b).getTime()});m(_)}catch(n){console.error("[useAdminConversations] Error:",n),c(n instanceof Error?n.message:"Failed to fetch conversations")}finally{p(!1)}},h=async(n,l)=>{try{const{error:f}=await x.rpc("admin_lock_conversation",{target_order_id:n,lock_reason:l});if(f)throw f;return await i(),{success:!0}}catch(f){return{success:!1,error:f instanceof Error?f.message:"Failed to lock"}}},d=async n=>{try{const{error:l}=await x.rpc("admin_unlock_conversation",{target_order_id:n});if(l)throw l;return await i(),{success:!0}}catch(l){return{success:!1,error:l instanceof Error?l.message:"Failed to unlock"}}};return o.useEffect(()=>{i()},[]),{conversations:a,isLoading:u,error:r,refetch:i,lockConversation:h,unlockConversation:d}},A=a=>{const[m,u]=o.useState([]),[p,r]=o.useState(!0);return o.useEffect(()=>{if(!a)return;const c=async()=>{r(!0);const{data:h,error:d}=await x.from("messages").select(`
                    *,
                    sender:profiles!messages_sender_id_fkey(id, full_name, avatar_url, email),
                    receiver:profiles!messages_receiver_id_fkey(id, full_name, avatar_url, email)
                `).eq("order_id",a).order("created_at",{ascending:!0});d||u(h||[]),r(!1)};c();const i=x.channel(`admin-messages:${a}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`order_id=eq.${a}`},()=>c()).subscribe();return()=>{x.removeChannel(i)}},[a]),{messages:m,isLoading:p}},P=()=>{const{conversations:a,isLoading:m,lockConversation:u,unlockConversation:p}=z(),[r,c]=o.useState(null),[i,h]=o.useState(""),[d,n]=o.useState(!1),[l,f]=o.useState("all"),[_,s]=o.useState(""),g=a.filter(t=>{if(_){const j=_.toLowerCase();if(!t.buyer.full_name.toLowerCase().includes(j)&&!t.seller.full_name.toLowerCase().includes(j)&&!t.order_number.toLowerCase().includes(j)&&!t.listing_title.toLowerCase().includes(j))return!1}switch(l){case"locked":return t.messages_locked;case"disputed":return t.has_dispute;case"active":return t.message_count>0&&!t.messages_locked;default:return!0}}),b=async()=>{!r||!i.trim()||(await u(r.order_id,i),n(!1),h(""))},y=async t=>{await p(t)};return m?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(v,{className:"animate-spin text-accent-primary",size:32})}):e.jsxs("div",{className:"space-y-6 animate-fade-in pb-12",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-textMain mb-2",children:"Conversations"}),e.jsx("p",{className:"text-textMuted",children:"Monitor and manage buyer-seller communications"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-sm text-textMuted",children:[a.length," total"]}),e.jsx("div",{className:"h-10 w-10 bg-accent-primary/10 rounded-xl flex items-center justify-center",children:e.jsx(w,{className:"text-accent-primary",size:20})})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(M,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-textMuted",size:18}),e.jsx("input",{type:"text",value:_,onChange:t=>s(t.target.value),placeholder:"Search by user, order, or item...",className:"w-full pl-10 pr-4 py-3 bg-surface border border-border rounded-xl text-textMain placeholder:text-textMuted focus:outline-none focus:border-accent-primary"})]}),e.jsx("div",{className:"flex gap-2 p-1 bg-surfaceHighlight/50 rounded-xl border border-border/50",children:["all","active","locked","disputed"].map(t=>e.jsx("button",{onClick:()=>f(t),className:`px-4 py-2 rounded-lg text-sm font-medium capitalize transition-all ${l===t?"bg-accent-tertiary text-textInverse shadow":"text-textMuted hover:text-textMain"}`,children:t},t))})]}),e.jsx("div",{className:"bg-surface border border-border rounded-2xl overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border bg-surfaceHighlight/50",children:[e.jsx("th",{className:"px-6 py-4 text-left text-xs font-bold text-textMuted uppercase tracking-wider",children:"Order"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-bold text-textMuted uppercase tracking-wider",children:"Participants"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-bold text-textMuted uppercase tracking-wider",children:"Item"}),e.jsx("th",{className:"px-6 py-4 text-center text-xs font-bold text-textMuted uppercase tracking-wider",children:"Messages"}),e.jsx("th",{className:"px-6 py-4 text-center text-xs font-bold text-textMuted uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-4 text-right text-xs font-bold text-textMuted uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-border",children:g.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-6 py-12 text-center text-textMuted",children:"No conversations found"})}):g.map(t=>e.jsxs("tr",{className:"hover:bg-surfaceHighlight/30 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-mono text-sm font-medium text-textMain",children:t.order_number}),e.jsx("span",{className:"text-xs text-textMuted capitalize",children:t.status})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[10px] bg-blue-500/10 text-blue-500 px-1.5 py-0.5 rounded font-bold",children:"BUYER"}),e.jsx("span",{className:"text-sm text-textMain truncate max-w-[120px]",children:t.buyer.full_name})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-[10px] bg-green-500/10 text-green-500 px-1.5 py-0.5 rounded font-bold",children:"SELLER"}),e.jsx("span",{className:"text-sm text-textMain truncate max-w-[120px]",children:t.seller.full_name})]})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"text-sm text-textMain truncate block max-w-[150px]",children:t.listing_title})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx("span",{className:`inline-flex items-center justify-center min-w-[24px] h-6 px-2 rounded-full text-xs font-bold ${t.message_count>0?"bg-accent-primary/10 text-accent-primary":"bg-surfaceHighlight text-textMuted"}`,children:t.message_count})}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsxs("div",{className:"flex justify-center gap-1",children:[t.messages_locked&&e.jsxs("span",{className:"px-2 py-1 bg-red-500/10 text-red-500 rounded text-[10px] font-bold flex items-center gap-1",children:[e.jsx(N,{size:10})," LOCKED"]}),t.has_dispute&&e.jsxs("span",{className:"px-2 py-1 bg-amber-500/10 text-amber-500 rounded text-[10px] font-bold flex items-center gap-1",children:[e.jsx(C,{size:10})," DISPUTE"]}),!t.messages_locked&&!t.has_dispute&&e.jsx("span",{className:"px-2 py-1 bg-green-500/10 text-green-500 rounded text-[10px] font-bold",children:"ACTIVE"})]})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>c(t),className:"p-2 hover:bg-accent-primary/10 text-textMuted hover:text-accent-primary rounded-lg transition-colors",title:"View Messages",children:e.jsx(L,{size:16})}),t.messages_locked?e.jsx("button",{onClick:()=>y(t.order_id),className:"p-2 hover:bg-green-500/10 text-textMuted hover:text-green-500 rounded-lg transition-colors",title:"Unlock Conversation",children:e.jsx(S,{size:16})}):e.jsx("button",{onClick:()=>{c(t),n(!0)},className:"p-2 hover:bg-red-500/10 text-textMuted hover:text-red-500 rounded-lg transition-colors",title:"Lock Conversation",children:e.jsx(N,{size:16})})]})})]},t.order_id))})]})}),r&&!d&&e.jsx(R,{conversation:r,onClose:()=>c(null)}),d&&r&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-6",onClick:()=>n(!1),children:e.jsxs("div",{className:"bg-surface border border-border rounded-2xl max-w-md w-full p-6",onClick:t=>t.stopPropagation(),children:[e.jsxs("h3",{className:"text-lg font-bold text-textMain mb-4 flex items-center gap-2",children:[e.jsx(N,{className:"text-red-500",size:20}),"Lock Conversation"]}),e.jsx("p",{className:"text-sm text-textMuted mb-4",children:"Locking will prevent both buyer and seller from sending new messages. Use during disputes or policy violations."}),e.jsx("textarea",{value:i,onChange:t=>h(t.target.value),placeholder:"Reason for locking (visible to admin only)...",className:"w-full p-3 bg-surfaceHighlight border border-border rounded-xl text-textMain placeholder:text-textMuted resize-none h-24 focus:outline-none focus:border-accent-primary mb-4"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>n(!1),className:"flex-1 py-2.5 border border-border rounded-xl text-textMuted hover:text-textMain transition-colors",children:"Cancel"}),e.jsx("button",{onClick:b,disabled:!i.trim(),className:"flex-1 py-2.5 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors disabled:opacity-50",children:"Lock Conversation"})]})]})})]})},R=({conversation:a,onClose:m})=>{const{messages:u,isLoading:p}=A(a.order_id);return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-6",onClick:m,children:e.jsxs("div",{className:"bg-surface border border-border rounded-2xl max-w-2xl w-full max-h-[85vh] flex flex-col",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-border flex items-center justify-between shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-textMain",children:a.order_number}),e.jsxs("p",{className:"text-xs text-textMuted",children:[a.buyer.full_name," â†” ",a.seller.full_name]})]}),e.jsx("button",{onClick:m,className:"p-2 hover:bg-surfaceHighlight rounded-lg text-textMuted",children:e.jsx(E,{size:20})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:p?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(v,{className:"animate-spin text-accent-primary",size:24})}):u.length===0?e.jsxs("div",{className:"text-center py-8 text-textMuted",children:[e.jsx(w,{size:32,className:"mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No messages in this conversation"})]}):u.map(r=>{const c=r.sender_id===a.buyer.id,i=c?a.buyer.full_name:a.seller.full_name,h=c?"BUYER":"SELLER",d=c?"blue":"green";return e.jsxs("div",{className:"flex flex-col gap-1 p-3 bg-surfaceHighlight/50 rounded-xl border border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[10px] bg-${d}-500/10 text-${d}-500 px-1.5 py-0.5 rounded font-bold`,children:h}),e.jsx("span",{className:"text-sm font-medium text-textMain",children:i})]}),e.jsx("span",{className:"text-xs text-textMuted",children:new Date(r.created_at).toLocaleString()})]}),e.jsx("p",{className:"text-sm text-textMain whitespace-pre-wrap",children:r.content}),r.attachments&&r.attachments.length>0&&e.jsx("div",{className:"flex gap-2 mt-2",children:r.attachments.map((n,l)=>e.jsxs("a",{href:n,target:"_blank",rel:"noreferrer",className:"text-xs text-accent-tertiary hover:underline",children:["Attachment ",l+1]},l))})]},r.id)})}),a.messages_locked&&e.jsxs("div",{className:"p-3 border-t border-border bg-red-500/5 flex items-center gap-2 text-sm text-red-500 shrink-0",children:[e.jsx(N,{size:14}),e.jsxs("span",{children:["Conversation locked: ",a.messages_lock_reason]})]})]})})};export{P as default};
