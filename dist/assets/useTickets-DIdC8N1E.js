import{a as o}from"./vendor-icons-BBHJ0ezg.js";import{b as v,s as m}from"./index-76QHltB_.js";const S=(e={})=>{const{user:i}=v(),[l,_]=o.useState([]),[f,d]=o.useState(!0),[s,n]=o.useState(null);return o.useEffect(()=>{(async()=>{if(i)try{if(d(!0),e.isAdmin){const{data:b,error:k}=await m.rpc("get_admin_tickets",{p_status:e.status==="all"?null:e.status||null});if(!k&&b){const t=b.map(r=>({id:r.id,ticket_number:r.ticket_number,order_id:r.order_id,listing_id:r.listing_id,created_by:r.created_by,subject:r.subject,category:r.category,status:r.status,priority:r.priority,source:r.source,buyer_id:r.buyer_id,seller_id:r.seller_id,involves_admin:r.involves_admin,contact_email:r.contact_email,contact_name:r.contact_name,created_at:r.created_at,updated_at:r.updated_at,resolved_at:r.resolved_at,order:r.order_number?{order_number:r.order_number,listing:r.listing_title?{title:r.listing_title}:void 0}:void 0,creator:r.creator_name?{full_name:r.creator_name,avatar_url:r.creator_avatar}:void 0}));_(t),d(!1);return}console.log("Admin RPC not available, falling back to regular query")}let a=m.from("tickets").select(`
                        id, ticket_number, order_id, listing_id, created_by, subject, category, status, priority,
                        buyer_id, seller_id, involves_admin, created_at, updated_at, resolved_at,
                        source, contact_email, contact_name,
                        order:orders(order_number, listing:listings(title)),
                        creator:profiles!tickets_created_by_fkey(full_name, avatar_url)
                    `).order("created_at",{ascending:!1});e.status&&e.status!=="all"&&(a=a.eq("status",e.status)),e.myTicketsOnly&&(a=a.or(`created_by.eq.${i.id},buyer_id.eq.${i.id},seller_id.eq.${i.id}`));const{data:u,error:y}=await a;if(y)throw y;_(u||[])}catch(a){n(a instanceof Error?a.message:"Failed to fetch tickets")}finally{d(!1)}})()},[i,e.status,e.myTicketsOnly,e.isAdmin]),{tickets:l,isLoading:f,error:s,refetch:async()=>{if(i){d(!0);try{if(e.isAdmin){const{data:y,error:b}=await m.rpc("get_admin_tickets",{p_status:e.status==="all"?null:e.status||null});if(!b&&y){const k=y.map(t=>({id:t.id,ticket_number:t.ticket_number,order_id:t.order_id,listing_id:t.listing_id,created_by:t.created_by,subject:t.subject,category:t.category,status:t.status,priority:t.priority,source:t.source,buyer_id:t.buyer_id,seller_id:t.seller_id,involves_admin:t.involves_admin,contact_email:t.contact_email,contact_name:t.contact_name,created_at:t.created_at,updated_at:t.updated_at,resolved_at:t.resolved_at,order:t.order_number?{order_number:t.order_number,listing:t.listing_title?{title:t.listing_title}:void 0}:void 0,creator:t.creator_name?{full_name:t.creator_name,avatar_url:t.creator_avatar}:void 0}));_(k),d(!1);return}}let c=m.from("tickets").select(`
                    id, ticket_number, order_id, listing_id, created_by, subject, category, status, priority,
                    buyer_id, seller_id, involves_admin, created_at, updated_at, resolved_at,
                    source, contact_email, contact_name,
                    order:orders(order_number, listing:listings(title)),
                    creator:profiles!tickets_created_by_fkey(full_name, avatar_url)
                `).order("created_at",{ascending:!1});e.status&&e.status!=="all"&&(c=c.eq("status",e.status)),e.myTicketsOnly&&(c=c.or(`created_by.eq.${i.id},buyer_id.eq.${i.id},seller_id.eq.${i.id}`));const{data:a,error:u}=await c;if(u)throw u;_(a||[])}catch(c){n(c instanceof Error?c.message:"Failed to fetch tickets")}finally{d(!1)}}}}},w=e=>{const{user:i}=v(),[l,_]=o.useState(null),[f,d]=o.useState([]),[s,n]=o.useState(!0),[g,c]=o.useState(null),a=async()=>{if(!(!e||!i))try{n(!0);const{data:u,error:y}=await m.from("tickets").select(`
                    id, ticket_number, order_id, created_by, subject, category, status, priority,
                    buyer_id, seller_id, involves_admin, created_at, updated_at, resolved_at,
                    order:orders(order_number, listing:listings(title)),
                    creator:profiles!tickets_created_by_fkey(full_name, avatar_url)
                `).eq("id",e).single();if(y)throw y;_(u);const{data:b,error:k}=await m.from("ticket_messages").select(`
                    id, ticket_id, sender_id, content, attachment_url, attachment_name, is_internal, created_at,
                    sender:profiles!ticket_messages_sender_id_fkey(full_name, avatar_url, role)
                `).eq("ticket_id",e).order("created_at",{ascending:!0});if(k)throw k;d(b||[])}catch(u){c(u instanceof Error?u.message:"Failed to fetch ticket")}finally{n(!1)}};return o.useEffect(()=>{a()},[e,i]),{ticket:l,messages:f,isLoading:s,error:g,refetch:a}},E=()=>{const{user:e}=v(),[i,l]=o.useState(!1),[_,f]=o.useState(null);return{createTicket:async s=>{if(!e)return{success:!1,error:"Not logged in"};l(!0),f(null);try{const n=s.orderId?"order":"direct",{data:g,error:c}=await m.from("tickets").insert({order_id:s.orderId||null,created_by:e.id,subject:s.subject,category:s.category,status:"open",priority:s.category==="refund_request"?"high":"normal",buyer_id:s.buyerId||null,seller_id:s.sellerId||null,involves_admin:s.involvesAdmin??s.category==="refund_request",source:n}).select("id").single();if(c)throw c;const{error:a}=await m.from("ticket_messages").insert({ticket_id:g.id,sender_id:e.id,content:s.message,is_internal:!1,sender_role:"buyer",visibility:"all"});if(a)throw a;return{success:!0,ticketId:g.id}}catch(n){const g=n instanceof Error?n.message:"Failed to create ticket";return f(g),{success:!1,error:g}}finally{l(!1)}},isLoading:i,error:_}},q=()=>{const{user:e}=v(),[i,l]=o.useState(!1),[_,f]=o.useState(null);return{sendMessage:async(s,n,g,c)=>{if(!e)return{success:!1,error:"Not logged in"};l(!0),f(null);try{const{error:a}=await m.from("ticket_messages").insert({ticket_id:s,sender_id:e.id,content:n,attachment_url:g||null,attachment_name:c||null,is_internal:!1});if(a)throw a;return await m.from("tickets").update({updated_at:new Date().toISOString()}).eq("id",s),{success:!0}}catch(a){const u=a instanceof Error?a.message:"Failed to send message";return f(u),{success:!1,error:u}}finally{l(!1)}},isLoading:i,error:_}},T=()=>{const{user:e}=v(),[i,l]=o.useState(!1);return{updateStatus:async(f,d)=>{if(!e)return{success:!1};l(!0);try{const s={status:d,updated_at:new Date().toISOString()};d==="resolved"&&(s.resolved_at=new Date().toISOString(),s.resolved_by=e.id);const{error:n}=await m.from("tickets").update(s).eq("id",f);if(n)throw n;return{success:!0}}catch(s){return{success:!1,error:s instanceof Error?s.message:"Failed to update status"}}finally{l(!1)}},isLoading:i}};export{w as a,q as b,T as c,E as d,S as u};
