import{a as o}from"./vendor-icons-BBHJ0ezg.js";import{b as m,s as i}from"./index-76QHltB_.js";const S=(e="all")=>{const[c,a]=o.useState([]),[f,s]=o.useState(!0),[n,r]=o.useState(null),t=async()=>{var l,d;try{s(!0),r(null);let u=i.from("refund_requests").select(`
                    id, order_id, reason, description, status, admin_notes, refund_amount,
                    created_at, reviewed_at, reviewed_by, completed_at,
                    buyer:profiles!buyer_id(full_name, email),
                    order:orders(order_number, price_amount, listing:listings(title), seller:profiles!orders_seller_id_fkey(full_name), buyer:profiles!orders_buyer_id_fkey(full_name, email))
                `).order("created_at",{ascending:!1});e&&e!=="all"&&(u=u.eq("status",e));const{data:_,error:w}=await u;if(w){if((l=w.message)!=null&&l.includes("relation")&&((d=w.message)!=null&&d.includes("does not exist"))){console.warn("refund_requests table does not exist yet. Please run the migration."),a([]),r("Refund requests table not found. Please run database migration.");return}throw w}a(_||[])}catch(u){r(u instanceof Error?u.message:"Failed to fetch refund requests")}finally{s(!1)}};return o.useEffect(()=>{t()},[e]),{requests:c,isLoading:f,error:n,refetch:t}},E=()=>{const{user:e}=m(),[c,a]=o.useState(!1),[f,s]=o.useState(null);return{createRequest:async r=>{var t,l,d,u;if(!e)return{success:!1,error:"Not logged in"};a(!0),s(null);try{const{data:_,error:w}=await i.from("orders").select("price_amount, buyer_id").eq("id",r.orderId).single();if(w||!_)throw new Error("Order not found");if(_.buyer_id!==e.id)throw new Error("You can only request refunds for your own orders");const{data:p,error:h}=await i.from("refund_requests").select("id").eq("order_id",r.orderId).eq("buyer_id",e.id).neq("status","rejected");if(h&&(t=h.message)!=null&&t.includes("relation")&&(l=h.message)!=null&&l.includes("does not exist"))throw new Error("Refund system is not configured. Please contact support or run database migration.");if(p&&p.length>0)throw new Error("A refund request already exists for this order");const{data:q,error:g}=await i.from("refund_requests").insert({order_id:r.orderId,reason:r.reason,description:r.description,status:"reported",refund_amount:_.price_amount}).select("id").single();if(g)throw(d=g.message)!=null&&d.includes("relation")&&((u=g.message)!=null&&u.includes("does not exist"))?new Error("Refund system is not configured. Please contact support or run database migration."):g;return{success:!0,requestId:q.id}}catch(_){const w=_ instanceof Error?_.message:"Failed to create refund request";return s(w),{success:!1,error:w}}finally{a(!1)}},isLoading:c,error:f}},L=()=>{const{user:e}=m(),[c,a]=o.useState(!1);return{updateStatus:async(s,n,r)=>{if(!e)return{success:!1};a(!0);try{const t={status:n,admin_notes:r||null};if(["approved","rejected","completed"].includes(n)&&(t.reviewed_at=new Date().toISOString(),t.reviewed_by=e.id),n==="completed"&&(t.completed_at=new Date().toISOString()),n==="completed"){const{data:d}=await i.from("refund_requests").select("order_id, refund_amount").eq("id",s).single();d&&await i.from("orders").update({status:"refunded"}).eq("id",d.order_id)}const{error:l}=await i.from("refund_requests").update(t).eq("id",s);if(l)throw l;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to update status"}}finally{a(!1)}},isLoading:c}},v=()=>{const{user:e}=m(),[c,a]=o.useState({available:0,pending:0,withdrawn:0}),[f,s]=o.useState(!0);return o.useEffect(()=>{(async()=>{if(e)try{const{data:r}=await i.from("profiles").select("available_balance, pending_balance, withdrawn_total").eq("id",e.id).single();r&&a({available:r.available_balance||0,pending:r.pending_balance||0,withdrawn:r.withdrawn_total||0})}catch(r){console.error("Failed to fetch balance:",r)}finally{s(!1)}})()},[e]),{balance:c,isLoading:f}},I=()=>{const{user:e}=m(),[c,a]=o.useState([]),[f,s]=o.useState(!0);return o.useEffect(()=>{(async()=>{if(!e)return;const{data:r}=await i.from("seller_withdrawals").select("*").eq("seller_id",e.id).order("created_at",{ascending:!1});a(r||[]),s(!1)})()},[e]),{withdrawals:c,isLoading:f}},R=()=>{const{user:e}=m(),[c,a]=o.useState(!1);return{requestWithdrawal:async(s,n,r)=>{if(!e)return{success:!1,error:"Not logged in"};a(!0);try{const{data:t}=await i.from("profiles").select("available_balance").eq("id",e.id).single();if(!t||t.available_balance<s)throw new Error("Insufficient balance");const{error:l}=await i.from("seller_withdrawals").insert({seller_id:e.id,amount:s,status:"pending",payment_method:n,payment_details:r});if(l)throw l;return{success:!0}}catch(t){return console.error("Withdrawal Request Error:",t),{success:!1,error:t.message||(typeof t=="string"?t:"Failed to request withdrawal")}}finally{a(!1)}},isLoading:c}},W=(e="all")=>{const[c,a]=o.useState([]),[f,s]=o.useState(!0),n=async()=>{s(!0);let r=i.from("seller_withdrawals").select(`
                id, seller_id, amount, status, payment_method, payment_details, admin_notes,
                created_at, processed_at,
                seller:profiles!seller_id(full_name, email)
            `).order("created_at",{ascending:!1});e&&e!=="all"&&(r=r.eq("status",e));const{data:t,error:l}=await r;l&&console.error("Error fetching admin withdrawals:",l),a(t||[]),s(!1)};return o.useEffect(()=>{n()},[e]),{withdrawals:c,isLoading:f,refetch:n}},k=()=>{const{user:e}=m(),[c,a]=o.useState(!1);return{processWithdrawal:async(s,n,r)=>{if(!e)return{success:!1};a(!0);try{const t={status:n,admin_notes:r||null};if((n==="completed"||n==="rejected")&&(t.processed_at=new Date().toISOString(),t.processed_by=e.id),n==="rejected"){const{data:d}=await i.from("seller_withdrawals").select("seller_id, amount").eq("id",s).single();if(d){const{data:u}=await i.from("profiles").select("available_balance").eq("id",d.seller_id).single();u&&await i.from("profiles").update({available_balance:u.available_balance+d.amount}).eq("id",d.seller_id)}}if(n==="completed"){const{data:d}=await i.from("seller_withdrawals").select("seller_id, amount").eq("id",s).single();if(d){const{data:u}=await i.from("profiles").select("withdrawn_total").eq("id",d.seller_id).single();u&&await i.from("profiles").update({withdrawn_total:(u.withdrawn_total||0)+d.amount}).eq("id",d.seller_id)}}const{error:l}=await i.from("seller_withdrawals").update(t).eq("id",s);if(l)throw l;return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Failed to process withdrawal"}}finally{a(!1)}},isLoading:c}},x=()=>{const{user:e}=m(),[c,a]=o.useState(null),[f,s]=o.useState(!0);return o.useEffect(()=>{(async()=>{if(!e)return;const{data:r}=await i.from("seller_bank_accounts").select("bank_name, account_number_last4, account_holder_name, upi_id").eq("seller_id",e.id).single();a(r),s(!1)})()},[e]),{bankDetails:c,isLoading:f}};export{v as a,I as b,R as c,x as d,S as e,L as f,W as g,k as h,E as u};
