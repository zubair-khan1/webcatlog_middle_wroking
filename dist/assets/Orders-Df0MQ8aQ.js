import{j as e}from"./vendor-motion-Dl8lXUsH.js";import{a as d,ao as Q,J as $,aH as B,z as W,s as G}from"./vendor-icons-BBHJ0ezg.js";import{s as u}from"./index-76QHltB_.js";import{L as J}from"./vendor-react-Ojr5pEEK.js";import"./vendor-supabase-CIvuJI4W.js";import"./vendor-date-BvD7TL1z.js";const te=()=>{const[n,_]=d.useState([]),[S,N]=d.useState(!0),[y,v]=d.useState(null),[f,O]=d.useState("all"),[b,k]=d.useState(""),[C,M]=d.useState(null),[c,w]=d.useState(1),[L,E]=d.useState(0),p=15,j=async()=>{N(!0),v(null);try{const{data:{user:t}}=await u.auth.getUser();console.log("[Admin Orders] Current user:",t==null?void 0:t.email,t==null?void 0:t.id);const{data:s}=await u.from("profiles").select("id, email, role").eq("id",t==null?void 0:t.id).single();console.log("[Admin Orders] User profile:",s);const{data:r,error:o}=await u.rpc("is_admin");console.log("[Admin Orders] is_admin() result:",r,"error:",o);const{count:x}=await u.from("orders").select("*",{count:"exact",head:!0});console.log("[Admin Orders] Total orders visible to me:",x);let l=u.from("orders").select(`
          *,
          listing:listings(id, title, image_url),
          buyer:profiles!orders_buyer_id_fkey(id, full_name, email),
          seller:profiles!orders_seller_id_fkey(id, full_name, email)
        `).order("created_at",{ascending:!1});f!=="all"&&(l=l.eq("status",f));const{data:a,error:i}=await l;if(console.log("[Admin Orders] Query result:",{count:a==null?void 0:a.length,data:a,error:i}),i)throw i;_(a||[]);const{data:m}=await u.from("seller_withdrawals").select("amount").eq("status","completed"),T=(m==null?void 0:m.reduce((F,I)=>F+Number(I.amount),0))||0;E(T)}catch(t){console.error("[AdminOrders] Error:",t),v(t instanceof Error?t.message:"Failed to fetch orders")}finally{N(!1)}};d.useEffect(()=>{j()},[f]);const A=async(t,s)=>{M(t);try{const{error:r}=await u.from("orders").update({status:s}).eq("id",t);if(r)throw r;j()}catch(r){console.error("Error updating order status:",r)}finally{M(null)}},h=n.filter(t=>{var r,o,x,l,a,i,m;if(!b)return!0;const s=b.toLowerCase();return((r=t.order_number)==null?void 0:r.toLowerCase().includes(s))||((x=(o=t.listing)==null?void 0:o.title)==null?void 0:x.toLowerCase().includes(s))||((a=(l=t.buyer)==null?void 0:l.full_name)==null?void 0:a.toLowerCase().includes(s))||((m=(i=t.seller)==null?void 0:i.full_name)==null?void 0:m.toLowerCase().includes(s))}),g=Math.ceil(h.length/p),H=h.slice((c-1)*p,c*p),P=t=>({created:"bg-surfaceHighlight text-textMuted",payment_pending:"bg-accent-secondary/10 text-accent-secondary-fg",paid:"bg-accent-tertiary/10 text-accent-tertiary",delivered:"bg-accent-primary/10 text-accent-primary",completed:"bg-accent-primary/20 text-accent-primary",refunded:"bg-red-500/10 text-red-500",disputed:"bg-orange-500/10 text-orange-500"})[t]||"bg-surfaceHighlight text-textMuted",z=n.filter(t=>["paid","delivered","completed"].includes(t.status)).reduce((t,s)=>t+Number(s.price_amount),0),D=n.filter(t=>["paid","delivered","completed"].includes(t.status)).reduce((t,s)=>t+Number(s.commission_amount),0),R=n.filter(t=>["paid","delivered","completed"].includes(t.status)).reduce((t,s)=>t+Number(s.seller_amount||0),0),U=n.filter(t=>t.status==="paid").length,q=n.filter(t=>t.status==="completed").length;return S?e.jsx("div",{className:"flex items-center justify-center h-[calc(100vh-200px)]",children:e.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-accent-primary border-t-transparent rounded-full"})}):e.jsxs("div",{className:"space-y-8 animate-fade-in pb-12",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold text-textMain mb-2",children:"All Orders"}),e.jsx("p",{className:"text-textMuted",children:"Manage transactions and resolve issues"})]}),e.jsx("button",{onClick:j,className:"p-2 rounded-lg bg-surfaceHighlight hover:bg-accent-tertiary/10 text-textMuted hover:text-accent-tertiary transition-colors",children:e.jsx(Q,{size:18})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"p-5 rounded-2xl bg-surface border border-border",children:[e.jsx("p",{className:"text-textMuted text-xs font-medium mb-1",children:"Total Orders"}),e.jsx("p",{className:"text-2xl font-display font-bold text-textMain",children:n.length}),e.jsxs("p",{className:"text-xs text-textMuted mt-1",children:[U," pending • ",q," complete"]})]}),e.jsxs("div",{className:"p-5 rounded-2xl bg-surface border border-border",children:[e.jsx("p",{className:"text-textMuted text-xs font-medium mb-1",children:"Total Revenue"}),e.jsxs("p",{className:"text-2xl font-display font-bold text-accent-primary",children:["₹",z.toLocaleString()]}),e.jsx("p",{className:"text-xs text-textMuted mt-1",children:"Gross transaction value"})]}),e.jsxs("div",{className:"p-5 rounded-2xl bg-surface border border-border",children:[e.jsx("p",{className:"text-textMuted text-xs font-medium mb-1",children:"Platform Earnings"}),e.jsxs("p",{className:"text-2xl font-display font-bold text-accent-tertiary",children:["₹",D.toLocaleString()]}),e.jsx("p",{className:"text-xs text-textMuted mt-1",children:"10% commission"})]}),e.jsxs("div",{className:"p-5 rounded-2xl bg-surface border border-border",children:[e.jsx("p",{className:"text-textMuted text-xs font-medium mb-1",children:"Seller Earnings"}),e.jsxs("p",{className:"text-2xl font-display font-bold text-accent-secondary-fg",children:["₹",R.toLocaleString()]}),e.jsx("p",{className:"text-xs text-textMuted mt-1",children:"Owed to sellers"})]}),e.jsxs("div",{className:"p-5 rounded-2xl bg-surface border border-border",children:[e.jsx("p",{className:"text-textMuted text-xs font-medium mb-1",children:"Total Payouts"}),e.jsxs("p",{className:"text-2xl font-display font-bold text-textMain",children:["₹",L.toLocaleString()]}),e.jsx("p",{className:"text-xs text-textMuted mt-1",children:"Processed withdrawals"})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx($,{size:18,className:"absolute left-4 top-1/2 -translate-y-1/2 text-textMuted"}),e.jsx("input",{type:"text",placeholder:"Search by order number, kit, buyer, seller...",value:b,onChange:t=>k(t.target.value),className:"w-full pl-12 pr-4 py-3 bg-surface border border-border rounded-xl text-textMain placeholder:text-textMuted focus:outline-none focus:border-accent-tertiary transition-colors"})]}),e.jsx("div",{className:"flex gap-2 p-1 bg-surfaceHighlight/50 rounded-xl border border-border/50",children:["all","paid","completed","disputed","refunded"].map(t=>e.jsx("button",{onClick:()=>O(t),className:`px-4 py-2 rounded-lg text-sm font-medium transition-all capitalize ${f===t?"bg-accent-tertiary text-textInverse shadow-sm":"text-textMuted hover:text-textMain"}`,children:t},t))})]}),y&&e.jsx("div",{className:"p-4 bg-red-500/10 border border-red-500/20 rounded-xl text-red-500",children:y}),e.jsx("div",{className:"bg-surface border border-border rounded-2xl overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-surfaceHighlight border-b border-border",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left text-xs font-bold text-textMuted uppercase tracking-wider px-6 py-4",children:"Order"}),e.jsx("th",{className:"text-left text-xs font-bold text-textMuted uppercase tracking-wider px-6 py-4",children:"Kit"}),e.jsx("th",{className:"text-left text-xs font-bold text-textMuted uppercase tracking-wider px-6 py-4",children:"Buyer"}),e.jsx("th",{className:"text-left text-xs font-bold text-textMuted uppercase tracking-wider px-6 py-4",children:"Seller"}),e.jsx("th",{className:"text-left text-xs font-bold text-textMuted uppercase tracking-wider px-6 py-4",children:"Amount"}),e.jsx("th",{className:"text-left text-xs font-bold text-textMuted uppercase tracking-wider px-6 py-4",children:"Status"}),e.jsx("th",{className:"text-left text-xs font-bold text-textMuted uppercase tracking-wider px-6 py-4",children:"Date"}),e.jsx("th",{className:"text-left text-xs font-bold text-textMuted uppercase tracking-wider px-6 py-4",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y divide-border",children:[H.map(t=>{var s,r,o,x,l,a;return e.jsxs("tr",{className:"hover:bg-surfaceHighlight/50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx("p",{className:"font-mono text-sm text-textMain",children:t.order_number})}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[((s=t.listing)==null?void 0:s.image_url)&&e.jsx("img",{src:t.listing.image_url,alt:"",className:"w-10 h-8 rounded object-cover"}),e.jsx("p",{className:"text-sm text-textMain line-clamp-1 max-w-[150px]",children:((r=t.listing)==null?void 0:r.title)||"Unknown"})]})}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("p",{className:"text-sm text-textMain",children:((o=t.buyer)==null?void 0:o.full_name)||"Unknown"}),e.jsx("p",{className:"text-xs text-textMuted",children:(x=t.buyer)==null?void 0:x.email})]}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsx("p",{className:"text-sm text-textMain",children:((l=t.seller)==null?void 0:l.full_name)||"Unknown"}),e.jsx("p",{className:"text-xs text-textMuted",children:(a=t.seller)==null?void 0:a.email})]}),e.jsxs("td",{className:"px-6 py-4",children:[e.jsxs("p",{className:"text-sm font-medium text-textMain",children:["₹",t.price_amount]}),e.jsxs("p",{className:"text-xs text-textMuted",children:["Fee: ₹",t.commission_amount]})]}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("select",{value:t.status,onChange:i=>A(t.id,i.target.value),disabled:C===t.id,className:`px-2.5 py-1 rounded-lg text-xs font-medium capitalize bg-surfaceHighlight border border-border text-textMain cursor-pointer focus:outline-none focus:border-accent-tertiary ${P(t.status)}`,children:[e.jsx("option",{value:"paid",children:"Paid"}),e.jsx("option",{value:"delivered",children:"Delivered"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"refunded",children:"Refunded"}),e.jsx("option",{value:"disputed",children:"Disputed"})]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("p",{className:"text-sm text-textMuted",children:new Date(t.created_at).toLocaleDateString()})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(J,{to:`/order/${t.id}`,className:"p-2 rounded-lg hover:bg-accent-tertiary/10 text-textMuted hover:text-accent-tertiary transition-colors inline-flex",children:e.jsx(B,{size:16})})})]},t.id)}),h.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-6 py-12 text-center text-textMuted",children:"No orders found"})})]})]})})}),g>1&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("p",{className:"text-sm text-textMuted",children:["Showing ",(c-1)*p+1," to ",Math.min(c*p,h.length)," of ",h.length," orders"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>w(t=>Math.max(1,t-1)),disabled:c===1,className:"p-2 rounded-lg bg-surface border border-border hover:bg-surfaceHighlight disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(W,{size:16,className:"text-textMuted"})}),e.jsxs("span",{className:"text-sm text-textMain px-3",children:["Page ",c," of ",g]}),e.jsx("button",{onClick:()=>w(t=>Math.min(g,t+1)),disabled:c===g,className:"p-2 rounded-lg bg-surface border border-border hover:bg-surfaceHighlight disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsx(G,{size:16,className:"text-textMuted"})})]})]})]})};export{te as default};
