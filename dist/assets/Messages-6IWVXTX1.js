import{j as e}from"./vendor-motion-Dl8lXUsH.js";import{a as l,J as F,aI as A,ax as U,aS as V,aT as H,ad as W,I as B,X as P,aU as I,v as K}from"./vendor-icons-BBHJ0ezg.js";import{b as R,s as h}from"./index-76QHltB_.js";import{u as G}from"./useOrders-B0f_Am1W.js";import{e as J,u as X,L as Q}from"./vendor-react-Ojr5pEEK.js";import"./vendor-supabase-CIvuJI4W.js";import"./vendor-date-BvD7TL1z.js";const Y=s=>{const{user:i}=R(),[x,o]=l.useState([]),[_,f]=l.useState(!0),[b,u]=l.useState(null),y=l.useRef(null),k=l.useCallback(async()=>{if(!s||!i){o([]),f(!1);return}f(!0),u(null);try{const{data:n,error:r}=await h.from("messages").select(`
          *,
          sender:profiles!messages_sender_id_fkey(id, full_name, avatar_url),
          receiver:profiles!messages_receiver_id_fkey(id, full_name, avatar_url)
        `).eq("order_id",s).order("created_at",{ascending:!0});if(r)throw r;o(n||[])}catch(n){console.error("[useMessages] Error:",n),u(n instanceof Error?n.message:"Failed to fetch messages")}finally{f(!1)}},[s,i]);l.useEffect(()=>{if(!s||!i)return;k();const n=h.channel(`messages:${s}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`order_id=eq.${s}`},r=>{o(a=>[...a,r.new])}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages",filter:`order_id=eq.${s}`},r=>{o(a=>a.map(d=>d.id===r.new.id?{...d,...r.new}:d))}).subscribe();return y.current=n,()=>{y.current&&h.removeChannel(y.current)}},[s,i,k]);const j=l.useCallback(async(n,r)=>{if(!s||!i||!n.trim()&&(!r||r.length===0))return!1;try{const{data:a,error:d}=await h.from("orders").select("buyer_id, seller_id, status").eq("id",s).single();if(d||!a)throw new Error("Order not found");if(!["paid","delivered","completed"].includes(a.status))throw new Error("Messaging is only available after payment");let N=[];if(r&&r.length>0)for(const S of r){const $=S.name.split(".").pop(),C=`${s}/${Date.now()}-${Math.random().toString(36).substring(7)}.${$}`,{data:m,error:z}=await h.storage.from("messages").upload(C,S);if(!z&&m){const{data:D}=h.storage.from("messages").getPublicUrl(m.path);N.push(D.publicUrl)}}const w=a.buyer_id===i.id?a.seller_id:a.buyer_id,E=a.buyer_id===i.id?"buyer":"seller",{error:v}=await h.from("messages").insert({order_id:s,sender_id:i.id,receiver_id:w,content:n.trim(),attachments:N.length>0?N:null,sender_role:E,message_type:N.length>0?"file":"text",visibility:"all"});if(v)throw v;return!0}catch(a){return console.error("[useMessages] Send error:",a),u(a instanceof Error?a.message:"Failed to send message"),!1}},[s,i]),c=l.useCallback(async n=>{if(i)try{await h.from("messages").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",n).eq("receiver_id",i.id)}catch(r){console.error("[useMessages] Mark as read error:",r)}},[i]),g=x.filter(n=>n.receiver_id===(i==null?void 0:i.id)&&!n.is_read).length;return{messages:x,isLoading:_,error:b,sendMessage:j,markAsRead:c,unreadCount:g}},Z=()=>{const{user:s}=R(),[i,x]=l.useState([]),[o,_]=l.useState(!0);return l.useEffect(()=>{if(!s)return;const f=async()=>{_(!0);try{const{data:u,error:y}=await h.from("orders").select(`
                        id, 
                        order_number, 
                        status,
                        buyer_id, 
                        seller_id,
                        buyer:profiles!orders_buyer_id_fkey(id, full_name, avatar_url),
                        seller:profiles!orders_seller_id_fkey(id, full_name, avatar_url),
                        listing:listings(title)
                    `).or(`buyer_id.eq.${s.id},seller_id.eq.${s.id}`).order("created_at",{ascending:!1});if(y)throw y;const j=(await Promise.all(u.map(async c=>{const g=c.buyer_id===s.id,n=g?c.seller:c.buyer,r=Array.isArray(n)?n[0]:n,a=c.listing,d=Array.isArray(a)?a[0]:a,{data:N}=await h.from("messages").select("content, created_at, is_read, sender_id").eq("order_id",c.id).order("created_at",{ascending:!1}).limit(1).single(),{count:w}=await h.from("messages").select("id",{count:"exact",head:!0}).eq("order_id",c.id).eq("receiver_id",s.id).eq("is_read",!1);return{order_id:c.id,order_number:c.order_number,other_party:r||{id:"warn",full_name:"Unknown User"},last_message:N||void 0,unread_count:w||0,listing_title:(d==null?void 0:d.title)||"Unknown Item",role:g?"buyer":"seller",status:c.status}}))).sort((c,g)=>{var a,d;const n=((a=c.last_message)==null?void 0:a.created_at)||"0";return(((d=g.last_message)==null?void 0:d.created_at)||"0").localeCompare(n)});x(j)}catch(u){console.error("Error fetching conversations:",u)}finally{_(!1)}};f();const b=h.channel("public:messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},u=>{(u.new.receiver_id===s.id||u.new.sender_id===s.id)&&f()}).subscribe();return()=>{b.unsubscribe()}},[s]),{conversations:i,isLoading:o}},ce=()=>{const{orderId:s}=J(),i=X(),{user:x}=R(),{conversations:o,isLoading:_}=Z(),{order:f}=G(s),{messages:b,isLoading:u,sendMessage:y,markAsRead:k}=Y(s),[j,c]=l.useState(""),[g,n]=l.useState(!1),[r,a]=l.useState([]),[d,N]=l.useState(!0),[w,E]=l.useState(!0),[v,S]=l.useState("list"),$=l.useRef(null),C=l.useRef(null),m=o.find(t=>t.order_id===s);l.useEffect(()=>{s?(S("chat"),b.filter(t=>t.receiver_id===(x==null?void 0:x.id)&&!t.is_read).forEach(t=>k(t.id))):o.length>0&&!s&&window.innerWidth>=768&&i(`/messages/${o[0].order_id}`)},[s,b,x,o]),l.useEffect(()=>{var t;(t=$.current)==null||t.scrollIntoView({behavior:"smooth"})},[b,r]);const z=async t=>{if(t.preventDefault(),!j.trim()&&r.length===0||g)return;n(!0),await y(j,r)&&(c(""),a([])),n(!1)},D=t=>{t.target.files&&a(p=>[...p,...Array.from(t.target.files)])},O=t=>{a(p=>p.filter((M,L)=>L!==t))},T=t=>new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return e.jsxs("div",{className:"min-h-screen bg-background flex overflow-hidden pt-[64px]",children:[e.jsxs("div",{className:`
                ${v==="list"?"flex":"hidden md:flex"} 
                w-full md:w-80 lg:w-96 flex-col border-r border-border bg-surface shrink-0
            `,children:[e.jsxs("div",{className:"p-4 border-b border-border flex items-center justify-between",children:[e.jsx("h2",{className:"font-display font-bold text-lg text-textMain",children:"Messages"}),e.jsx("div",{className:"p-2 bg-surfaceHighlight rounded-lg",children:e.jsx(F,{size:18,className:"text-textMuted"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:_?e.jsx("div",{className:"p-4 text-center",children:e.jsx("div",{className:"animate-spin w-6 h-6 border-2 border-accent-primary border-t-transparent rounded-full mx-auto"})}):o.length===0?e.jsxs("div",{className:"p-8 text-center text-textMuted",children:[e.jsx(A,{size:32,className:"mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No active conversations"}),e.jsx("p",{className:"text-xs mt-1",children:"Chat starts after you purchase a kit"})]}):o.map(t=>{var p;return e.jsxs("div",{onClick:()=>i(`/messages/${t.order_id}`),className:`
                                    p-4 border-b border-border hover:bg-surfaceHighlight cursor-pointer transition-colors
                                    ${t.order_id===s?"bg-accent-primary/5 border-l-4 border-l-accent-primary":"border-l-4 border-l-transparent"}
                                `,children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.other_party.avatar_url?e.jsx("img",{src:t.other_party.avatar_url,className:"w-6 h-6 rounded-full"}):e.jsx("div",{className:"w-6 h-6 rounded-full bg-accent-secondary/10 flex items-center justify-center text-xs text-accent-secondary font-bold",children:t.other_party.full_name[0]}),e.jsx("span",{className:"font-medium text-textMain text-sm truncate max-w-[120px]",children:t.other_party.full_name}),e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded uppercase font-bold ${t.role==="buyer"?"bg-blue-500/10 text-blue-500":"bg-green-500/10 text-green-500"}`,children:t.role})]}),e.jsx("span",{className:"text-xs text-textMuted whitespace-nowrap",children:t.last_message?new Date(t.last_message.created_at).toLocaleDateString():""})]}),e.jsx("p",{className:"text-xs font-medium text-textMain truncate mb-1",children:t.listing_title}),e.jsxs("div",{className:"flex justify-between items-center text-xs",children:[e.jsx("span",{className:"text-textMuted truncate max-w-[200px]",children:((p=t.last_message)==null?void 0:p.content)||"Started a conversation"}),t.unread_count>0&&e.jsx("span",{className:"bg-red-500 text-white px-1.5 py-0.5 rounded-full text-[10px] font-bold min-w-[18px] text-center",children:t.unread_count})]})]},t.order_id)})})]}),e.jsx("div",{className:`
                ${v==="chat"?"flex":"hidden md:flex"} 
                flex-1 flex-col bg-background relative
            `,children:s?u||_?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-textMuted",children:[e.jsx("div",{className:"animate-spin w-8 h-8 border-2 border-accent-primary border-t-transparent rounded-full mb-4"}),e.jsx("p",{children:"Loading conversation..."})]}):m?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"h-16 px-6 border-b border-border flex items-center justify-between bg-surface/50 backdrop-blur-sm sticky top-0 z-10",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>S("list"),className:"md:hidden p-2 -ml-2 hover:bg-surfaceHighlight rounded-lg text-textMuted",children:e.jsx(U,{size:20})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("h3",{className:"font-bold text-textMain flex items-center gap-2",children:[m==null?void 0:m.other_party.full_name,(m==null?void 0:m.role)==="buyer"&&e.jsx("span",{className:"text-xs font-medium text-textMuted px-2 py-0.5 rounded-full bg-surfaceHighlight",children:"Purchased Item"})]}),e.jsxs("p",{className:"text-xs text-green-500 flex items-center gap-1",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"}),"Online"]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{onClick:()=>E(!w),className:`p-2 rounded-lg hover:bg-surfaceHighlight transition-colors ${w?"text-accent-primary bg-accent-primary/5":"text-textMuted"}`,children:e.jsx(V,{size:20})})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[b.map((t,p)=>{const M=t.sender_id===(x==null?void 0:x.id);return e.jsx("div",{className:`flex ${M?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex flex-col max-w-[80%] ${M?"items-end":"items-start"}`,children:[e.jsxs("div",{className:`
                                                p-4 rounded-2xl relative group shadow-sm
                                                ${M?"bg-accent-primary text-accent-primary-fg rounded-br-none":"bg-surface border border-border text-textMain rounded-bl-none"}
                                            `,children:[t.content&&e.jsx("p",{className:"whitespace-pre-wrap text-sm leading-relaxed",children:t.content}),t.attachments&&t.attachments.length>0&&e.jsx("div",{className:`grid gap-2 mt-2 ${t.content?"pt-2 border-t border-white/20":""}`,children:t.attachments.map((L,q)=>e.jsxs("a",{href:L,target:"_blank",rel:"noreferrer",className:`flex items-center gap-2 p-2 rounded-lg text-xs transition-colors ${M?"bg-black/10 hover:bg-black/20":"bg-surfaceHighlight hover:bg-border"}`,children:[e.jsx(H,{size:16}),e.jsxs("span",{className:"truncate max-w-[150px]",children:["Attachment ",q+1]}),e.jsx(W,{size:14,className:"ml-auto opacity-70"})]},q))})]}),e.jsxs("div",{className:"flex items-center gap-1 mt-1 text-[10px] text-textMuted px-1",children:[e.jsx("span",{children:T(t.created_at)}),M&&e.jsx("span",{children:t.is_read?"• Read":"• Sent"})]})]})},t.id)}),e.jsx("div",{ref:$})]}),r.length>0&&e.jsx("div",{className:"px-6 py-3 border-t border-border bg-surfaceHighlight/30 flex gap-3 overflow-x-auto",children:r.map((t,p)=>e.jsxs("div",{className:"relative group shrink-0",children:[e.jsx("div",{className:"w-16 h-16 rounded-lg bg-surface border border-border flex flex-col items-center justify-center",children:t.type.startsWith("image/")?e.jsx(B,{size:20,className:"text-textMuted"}):e.jsx(H,{size:20,className:"text-textMuted"})}),e.jsx("button",{onClick:()=>O(p),className:"absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 shadow-md opacity-0 group-hover:opacity-100 transition-opacity",children:e.jsx(P,{size:12})}),e.jsx("span",{className:"text-[10px] text-textMuted truncate w-16 block text-center mt-1",children:t.name})]},p))}),e.jsxs("div",{className:"p-4 bg-surface border-t border-border",children:[e.jsxs("form",{onSubmit:z,className:"flex gap-4 items-end bg-surfaceHighlight p-2 rounded-xl border border-border focus-within:border-accent-primary/50 focus-within:ring-1 focus-within:ring-accent-primary/20 transition-all shadow-sm",children:[e.jsx("button",{type:"button",onClick:()=>{var t;return(t=C.current)==null?void 0:t.click()},className:"p-3 text-textMuted hover:text-accent-primary transition-colors hover:bg-surface rounded-lg",title:"Attach files",children:e.jsx(I,{size:20})}),e.jsx("input",{type:"file",multiple:!0,className:"hidden",ref:C,onChange:D}),e.jsx("textarea",{value:j,onChange:t=>c(t.target.value),onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),z(t))},placeholder:r.length>0?"Add a message...":"Type a message to start conversation...",className:"flex-1 bg-transparent border-none focus:ring-0 text-textMain placeholder:text-textMuted resize-none py-3 max-h-32 text-sm",rows:1}),e.jsx("button",{type:"submit",disabled:!j.trim()&&r.length===0||g,className:"p-3 bg-accent-primary text-accent-primary-fg rounded-lg hover:bg-accent-primary-dim transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-accent-primary/20",children:g?e.jsx("div",{className:"w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"}):e.jsx(K,{size:20})})]}),e.jsx("p",{className:"text-[10px] text-textMuted text-center mt-2",children:"Press Enter to send, Shift + Enter for new line"})]})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-textMuted",children:[e.jsx("div",{className:"w-16 h-16 bg-surfaceHighlight rounded-full flex items-center justify-center mb-4",children:e.jsx(A,{size:32})}),e.jsx("p",{className:"text-textMain font-medium mb-2",children:"Conversation Not Found"}),e.jsx("p",{className:"text-sm text-textMuted mb-4",children:"This order may not exist or you don't have access."}),e.jsx("button",{onClick:()=>i("/dashboard"),className:"px-4 py-2 text-sm bg-surface border border-border rounded-lg hover:bg-surfaceHighlight transition-colors",children:"Go to Dashboard"})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-textMuted",children:[e.jsx("div",{className:"w-16 h-16 bg-surfaceHighlight rounded-full flex items-center justify-center mb-4",children:e.jsx(A,{size:32})}),e.jsx("p",{children:"Select a conversation to start chatting"})]})}),w&&f&&e.jsxs("div",{className:`
                    absolute inset-y-0 right-0 w-80 bg-surface border-l border-border shadow-xl transform transition-transform z-20 pt-[64px]
                    ${v==="chat"&&w?"translate-x-0":"translate-x-full md:translate-x-0 md:relative md:block hidden"}
                `,children:[e.jsxs("div",{className:"h-16 px-6 border-b border-border flex items-center justify-between",children:[e.jsx("h3",{className:"font-bold text-textMain",children:"Contract Details"}),e.jsx("button",{onClick:()=>E(!1),className:"md:hidden p-2",children:e.jsx(P,{size:20})})]}),e.jsxs("div",{className:"p-6 space-y-8 overflow-y-auto h-[calc(100vh-128px)]",children:[e.jsxs("div",{className:"p-4 rounded-xl bg-surfaceHighlight border border-border",children:[e.jsx("p",{className:"text-xs font-bold text-textMuted uppercase tracking-wider mb-2",children:"Status"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`w-2.5 h-2.5 rounded-full ${f.status==="completed"?"bg-green-500":"bg-accent-primary animate-pulse"}`}),e.jsx("span",{className:"text-sm font-medium text-textMain capitalize",children:f.status.replace("_"," ")})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-textMuted uppercase tracking-wider mb-3",children:"Financials"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-textSecondary",children:"Total Amount"}),e.jsxs("span",{className:"font-mono font-medium text-textMain",children:["₹",f.price_amount]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-textSecondary",children:"Escrow Status"}),e.jsx("span",{className:"text-green-500 font-medium text-xs bg-green-500/10 px-2 py-0.5 rounded",children:"Funded"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Q,{to:`/order/${s}`,className:"block w-full py-2.5 text-center rounded-lg border border-border hover:bg-accent-primary/5 hover:border-accent-primary/30 hover:text-accent-primary transition-all text-sm font-medium",children:"View Original Order"}),(m==null?void 0:m.role)==="buyer"?e.jsx("button",{className:"block w-full py-2.5 text-center rounded-lg bg-green-600 text-white hover:bg-green-700 transition-all text-sm font-medium shadow-lg shadow-green-600/20",children:"Approve & Release Payment"}):e.jsx("button",{className:"block w-full py-2.5 text-center rounded-lg bg-accent-primary text-accent-primary-fg hover:bg-accent-primary-dim transition-all text-sm font-medium shadow-lg shadow-accent-primary/20",children:"Submit Work for Approval"})]}),e.jsxs("div",{className:"p-4 rounded-xl bg-blue-500/5 border border-blue-500/10 flex gap-3",children:[e.jsx(A,{className:"text-blue-500 shrink-0 mt-0.5",size:16}),e.jsx("p",{className:"text-xs text-blue-400/80 leading-relaxed",children:"Keep all communication within the platform. Payments made outside are not protected."})]})]})]})]})};export{ce as default};
