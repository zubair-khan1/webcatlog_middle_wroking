import{j as e}from"./vendor-motion-Dl8lXUsH.js";import{a as d,o as C,U as E,bg as z,x as k,aB as R,at as M,L as D,v as I,h as U}from"./vendor-icons-BBHJ0ezg.js";import{s as f,S as q,M as A}from"./index-76QHltB_.js";import{f as F,a as O}from"./vendor-date-BvD7TL1z.js";import"./vendor-react-Ojr5pEEK.js";import"./vendor-supabase-CIvuJI4W.js";const T=()=>{const[c,i]=d.useState([]),[l,p]=d.useState(null),[g,x]=d.useState([]),[a,h]=d.useState(!1),[y,m]=d.useState(null);d.useEffect(()=>{const n=f.channel("admin-conversations").on("postgres_changes",{event:"INSERT",schema:"public",table:"support_conversations"},s=>{const t=s.new;i(r=>[t,...r])}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"support_conversations"},s=>{const t=s.new;i(r=>r.map(u=>u.id===t.id?t:u)),(l==null?void 0:l.id)===t.id&&p(t)}).subscribe();return()=>{f.removeChannel(n)}},[l==null?void 0:l.id]),d.useEffect(()=>{if(!l)return;const n=f.channel(`admin-messages:${l.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"support_messages",filter:`conversation_id=eq.${l.id}`},s=>{const t=s.new;x(r=>r.some(b=>b.id===t.id)||r.some(b=>b.id.startsWith("temp-")&&b.message===t.message&&b.sender_id===t.sender_id)?r:[...r,t])}).subscribe();return()=>{f.removeChannel(n)}},[l==null?void 0:l.id]);const o=d.useCallback(async(n="new")=>{try{h(!0),m(null);let s=f.from("support_conversations").select("*");switch(n){case"new":s=s.order("created_at",{ascending:!1});break;case"old":s=s.order("created_at",{ascending:!0});break;case"unread":s=s.order("last_message_at",{ascending:!1,nullsFirst:!1});break}const{data:t,error:r}=await s;if(r)throw r;i(t||[])}catch(s){console.error("Error loading conversations:",s),m("Failed to load conversations")}finally{h(!1)}},[]),j=d.useCallback(async n=>{try{h(!0),m(null);const{data:s,error:t}=await f.from("support_conversations").select("*").eq("id",n).single();if(t)throw t;p(s);const{data:r,error:u}=await f.from("support_messages").select("*").eq("conversation_id",n).order("created_at",{ascending:!0});if(u)throw u;x(r||[]),await N(n)}catch(s){console.error("Error selecting conversation:",s),m("Failed to load conversation")}finally{h(!1)}},[]),w=d.useCallback(async(n,s)=>{try{m(null);const{data:{user:t}}=await f.auth.getUser();if(!t)throw new Error("Not authenticated");const r={id:`temp-${Date.now()}`,conversation_id:n,sender_type:"admin",sender_id:t.id,message:s,read_at:null,created_at:new Date().toISOString()};x(_=>[..._,r]);const{data:u,error:b}=await f.from("support_messages").insert({conversation_id:n,sender_type:"admin",sender_id:t.id,message:s}).select().single();if(b)throw b;x(_=>_.map(S=>S.id===r.id?u:S))}catch(t){console.error("Error sending admin reply:",t),m("Failed to send message"),x(r=>r.filter(u=>!u.id.startsWith("temp-")))}},[]),v=d.useCallback(async(n,s)=>{try{m(null);const{error:t}=await f.from("support_conversations").update({status:s,updated_at:new Date().toISOString()}).eq("id",n);if(t)throw t;s==="resolved"&&await f.from("support_messages").insert({conversation_id:n,sender_type:"system",sender_id:null,message:q.resolvedMessage}),i(r=>r.map(u=>u.id===n?{...u,status:s}:u)),(l==null?void 0:l.id)===n&&p(r=>r?{...r,status:s}:null)}catch(t){console.error("Error updating status:",t),m("Failed to update status")}},[l==null?void 0:l.id]),N=d.useCallback(async n=>{try{const{error:s}=await f.from("support_messages").update({read_at:new Date().toISOString()}).eq("conversation_id",n).eq("sender_type","user").is("read_at",null);if(s)throw s;x(t=>t.map(r=>r.sender_type==="user"&&!r.read_at?{...r,read_at:new Date().toISOString()}:r))}catch(s){console.error("Error marking messages as read:",s)}},[]);return{conversations:c,selectedConversation:l,messages:g,isLoading:a,error:y,loadConversations:o,selectConversation:j,sendAdminReply:w,updateStatus:v,markMessagesAsRead:N}},$=({conversations:c,selectedId:i,onSelect:l,sortBy:p,onSortChange:g})=>{const x=a=>{if(!a)return"No messages yet";try{return F(new Date(a),{addSuffix:!0})}catch{return"Recently"}};return e.jsxs("div",{className:"h-full flex flex-col bg-surface border-r border-border",children:[e.jsxs("div",{className:"p-4 border-b border-border",children:[e.jsx("h2",{className:"text-lg font-bold text-textMain mb-3",children:"Support Inbox"}),e.jsx("div",{className:"flex gap-2",children:["new","unread","old"].map(a=>e.jsx("button",{onClick:()=>g(a),className:`px-3 py-1 rounded-lg text-xs font-medium transition-all ${p===a?"bg-accent-primary text-black":"bg-surfaceHighlight text-textMuted hover:text-textMain"}`,children:a==="new"?"Newest":a==="unread"?"Unread":"Oldest"},a))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:c.length===0?e.jsxs("div",{className:"p-8 text-center text-textMuted text-sm",children:[e.jsx(C,{size:32,className:"mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No conversations yet"})]}):c.map(a=>e.jsx("button",{onClick:()=>l(a.id),className:`w-full p-4 border-b border-border text-left hover:bg-surfaceHighlight transition-colors ${i===a.id?"bg-surfaceHighlight":""}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-accent-primary/10 flex items-center justify-center flex-shrink-0",children:e.jsx(E,{size:20,className:"text-accent-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1",children:[e.jsx("h3",{className:"font-bold text-textMain text-sm truncate",children:a.name||a.email}),e.jsx("span",{className:`flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold ${a.status==="open"?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400":"bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400"}`,children:a.status})]}),e.jsx("p",{className:"text-xs text-textMuted truncate mb-1",children:a.email}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[10px] text-textMuted font-mono",children:x(a.last_message_at)}),a.unread_count&&a.unread_count>0&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{size:8,className:"text-accent-primary fill-accent-primary"}),e.jsx("span",{className:"text-[10px] font-bold text-accent-primary",children:a.unread_count})]})]})]})]})},a.id))})]})},H=({conversation:c,onStatusChange:i})=>e.jsxs("div",{className:"p-4 border-b border-border bg-surface",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-accent-primary/10 flex items-center justify-center flex-shrink-0",children:e.jsx(E,{size:24,className:"text-accent-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-bold text-textMain text-lg truncate",children:c.name||"Guest User"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-textMuted mt-1",children:[e.jsx(C,{size:14}),e.jsx("span",{className:"truncate",children:c.email})]}),c.user_id&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-textMuted mt-1",children:[e.jsx(k,{size:12,className:"text-green-500"}),e.jsx("span",{children:"Authenticated User"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-textMuted mt-1",children:[e.jsx(R,{size:12}),e.jsxs("span",{children:["Started ",O(new Date(c.created_at),"MMM d, yyyy")]})]})]})]}),e.jsxs("div",{className:"flex-shrink-0 flex flex-col gap-2",children:[c.status==="open"?e.jsxs("button",{onClick:()=>i("resolved"),className:"px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-colors flex items-center gap-2",children:[e.jsx(k,{size:16}),"Mark as Resolved"]}):e.jsxs("button",{onClick:()=>i("open"),className:"px-4 py-2 bg-surface border border-border hover:bg-surfaceHighlight text-textMain rounded-lg font-medium transition-colors flex items-center gap-2",children:[e.jsx(M,{size:16}),"Reopen Chat"]}),e.jsx("div",{className:`px-3 py-1 rounded-full text-xs font-bold text-center ${c.status==="open"?"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400":"bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400"}`,children:c.status==="open"?"Active":"Resolved"})]})]}),e.jsx("div",{className:"mt-4 flex items-center gap-4 text-xs font-mono text-textMuted",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(M,{size:12}),e.jsxs("span",{children:["ID: ",c.id.slice(0,8),"..."]})]})})]}),L=({conversation:c,messages:i,onSendReply:l})=>{const[p,g]=d.useState(""),[x,a]=d.useState(!1),h=d.useRef(null);d.useEffect(()=>{var o;(o=h.current)==null||o.scrollIntoView({behavior:"smooth"})},[i]);const y=async o=>{if(o.preventDefault(),!(!p.trim()||x)){a(!0);try{await l(p),g("")}catch(j){console.error("Error sending message:",j)}finally{a(!1)}}},m=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),y(o))};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[i.length===0?e.jsx("div",{className:"text-center text-textMuted text-sm py-8",children:e.jsx("p",{children:"No messages yet in this conversation."})}):i.map(o=>e.jsx(A,{message:o,isCurrentUser:o.sender_type==="admin"},o.id)),e.jsx("div",{ref:h})]}),e.jsxs("form",{onSubmit:y,className:"p-4 border-t border-border bg-surface",children:[e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("textarea",{value:p,onChange:o=>g(o.target.value),onKeyPress:m,placeholder:"Type your reply...",rows:2,className:"flex-1 bg-surfaceHighlight border border-border rounded-lg px-3 py-2 text-textMain placeholder:text-textMuted focus:border-accent-primary focus:outline-none focus:ring-1 focus:ring-accent-primary resize-none max-h-32"}),e.jsx("button",{type:"submit",disabled:!p.trim()||x,className:"bg-accent-primary text-black p-3 rounded-lg hover:bg-accent-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0",children:x?e.jsx(D,{size:20,className:"animate-spin"}):e.jsx(I,{size:20})})]}),e.jsx("p",{className:"text-[10px] text-textMuted mt-2 font-mono",children:"Press Enter to send, Shift+Enter for new line"})]})]})},J=()=>{const{conversations:c,selectedConversation:i,messages:l,isLoading:p,error:g,loadConversations:x,selectConversation:a,sendAdminReply:h,updateStatus:y}=T(),[m,o]=d.useState("new");d.useEffect(()=>{x(m)},[m]);const j=n=>{o(n),x(n)},w=async n=>{await a(n)},v=async n=>{i&&await h(i.id,n)},N=async n=>{i&&await y(i.id,n)};return e.jsx("div",{className:"min-h-screen bg-background pt-20",children:e.jsxs("div",{className:"h-[calc(100vh-80px)] flex",children:[e.jsx("div",{className:"w-full md:w-[350px] lg:w-[400px] border-r border-border",children:e.jsx($,{conversations:c,selectedId:(i==null?void 0:i.id)||null,onSelect:w,sortBy:m,onSortChange:j})}),e.jsxs("div",{className:"flex-1 flex flex-col",children:[p&&!i?e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx(D,{className:"animate-spin text-accent-primary",size:48})}):i?e.jsxs(e.Fragment,{children:[e.jsx(H,{conversation:i,onStatusChange:N}),e.jsx(L,{conversation:i,messages:l,onSendReply:v})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center text-center p-8",children:[e.jsx(U,{size:64,className:"text-textMuted/30 mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-textMain mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-textMuted max-w-md",children:"Choose a conversation from the sidebar to view messages and reply to users."})]}),g&&e.jsx("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 border-t border-red-200 dark:border-red-800 text-sm text-red-700 dark:text-red-300",children:g})]})]})})};export{J as default};
